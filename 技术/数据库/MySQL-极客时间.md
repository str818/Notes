## 1. 基础架构：一条SQL查询语句是如何执行的？

MySQL 可以分为 Server 层和存储引擎层两部分。

<div align="center"> <img src="https://s1.ax1x.com/2020/10/28/B3FmXn.png" width="70%"/> </div> 

### 连接器

**连接器** 负责跟客户端建立连接、获取权限、维持和管理连接，连接命令为：`mysql -h$ip -P$port -u$user -p`。连接后，可使用 `show processlist` 命令查看连接结果。客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 `wait_timeout` 控制的，默认值是 8 小时。

数据库里面，**长连接** 是指连接成功后，如果客户端持续有请求，则一直使用同一个连接。**短连接** 则是指每次执行完很少的几次查询就断开连接，下次查询再重新建立一个。由于建立连接过程复杂，尽量使用长连接，减少建立连接的动作。

### 查询缓存

MySQL 拿到一个查询请求后，会先到查询缓存看看，之前是不是执行过这条语句。之前执行过的语句及其结果可能会以 key-value 对的形式，被直接缓存在内存中。key 是查询的语句，value 是查询的结果。如果你的查询能够直接在这个缓存中找到 key，那么这个 value 就会被直接返回给客户端。

**大多数情况下建议不要使用查询缓存**，查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。

MySQL 8.0 版本直接将查询缓存的整块功能删掉了。

### 分析器

对命令进行**词法分析**与**语法分析**。

### 优化器

优化器是在表里面有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联（join）的时候，决定各个表的连接顺序。

### 执行器

MySQL 通过分析器知道了你要做什么，通过优化器知道了该怎么做，于是就进入了执行器阶段，开始执行语句。执行器将遍历过程中所有满足条件的行组成的记录集作为结果集返回给客户端。

## 2. 日志系统：一条SQL更新语句是如何执行的？

与查询流程不一样的是，更新流程还涉及两个重要的日志模块：redo log（重做日志）和 binlog（归档日志），通过这两个日志，MySQL 可以恢复到半个月内任意一秒的状态。

